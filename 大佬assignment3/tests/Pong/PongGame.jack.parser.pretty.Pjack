class PongGame
{
    static PongGame instance ;
    field Bat bat ;
    field Ball ball ;
    field int wall ;
    field boolean exit ;
    field int score ;
    field int lastWall ;
    field int batWidth ;

    constructor PongGame PongGame.new()
    {
        do Screen.clearScreen() ;
        let batWidth = 50 ;
        let bat = Bat.new(230,229,batWidth,7) ;
        let ball = Ball.new(253,222,0,511,0,229) ;
        do ball.setDestination(400,0) ;
        do Screen.drawRectangle(0,238,511,240) ;
        do Output.moveCursor(22,0) ;
        do Output.printString("Score: 0") ;
        let exit = false ;
        let score = 0 ;
        let wall = 0 ;
        let lastWall = 0 ;
        return this ;
    }

    method void PongGame.dispose()
    {
        do bat.dispose() ;
        do ball.dispose() ;
        do Memory.deAlloc(this) ;
        return ;
    }

    function void PongGame.newInstance()
    {
        let instance = PongGame.new() ;
        return ;
    }

    function PongGame PongGame.getInstance()
    {
        return instance ;
    }

    method void PongGame.run()
    {
        var char key ;

        while (~exit)
        {
            while (key = 0 & ~exit)
            {
                let key = Keyboard.keyPressed() ;
                do bat.move() ;
                do this.moveBall() ;
            }

            if (key = 130)
            {
                do bat.setDirection(1) ;
            }
            else
            {
                if (key = 132)
                {
                    do bat.setDirection(2) ;
                }
                else
                {
                    if (key = 140)
                    {
                        let exit = true ;
                    }
                }
            }

            while (~key = 0 & ~exit)
            {
                let key = Keyboard.keyPressed() ;
                do bat.move() ;
                do this.moveBall() ;
            }
        }

        if (exit)
        {
            do Output.moveCursor(10,27) ;
            do Output.printString("Game Over") ;
        }

        return ;
    }

    method void PongGame.moveBall()
    {
        var int bouncingDirection ;
        var int batLeft ;
        var int batRight ;
        var int ballLeft ;
        var int ballRight ;

        let wall = ball.move() ;
        if (wall > 0 & ~wall = lastWall)
        {
            let lastWall = wall ;
            let bouncingDirection = 0 ;
            let batLeft = bat.getLeft() ;
            let batRight = bat.getRight() ;
            let ballLeft = ball.getLeft() ;
            let ballRight = ball.getRight() ;
            if (wall = 4)
            {
                let exit = batLeft > ballRight | batRight < ballLeft ;
                if (~exit)
                {
                    if (ballRight < batLeft + 10)
                    {
                        let bouncingDirection = -1 ;
                    }
                    else
                    {
                        if (ballLeft > batRight - 10)
                        {
                            let bouncingDirection = 1 ;
                        }
                    }

                    let batWidth = batWidth - 2 ;
                    do bat.setWidth(batWidth) ;
                    let score = score + 1 ;
                    do Output.moveCursor(22,7) ;
                    do Output.printInt(score) ;
                }
            }

            do ball.bounce(bouncingDirection) ;
        }

        return ;
    }
}
